<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 1 Working with lists and iteration | 04_working_with_lists.utf8</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 1 Working with lists and iteration | 04_working_with_lists.utf8" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 1 Working with lists and iteration | 04_working_with_lists.utf8" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path=""><a href="#working-with-lists-and-iteration"><i class="fa fa-check"></i><b>1</b> Working with lists and iteration</a><ul>
<li class="chapter" data-level="1.1" data-path=""><a href="#list-columns-with-tidyr"><i class="fa fa-check"></i><b>1.1</b> List columns with <code>tidyr</code></a><ul>
<li class="chapter" data-level="1.1.1" data-path=""><a href="#nesting-data"><i class="fa fa-check"></i><b>1.1.1</b> Nesting data</a></li>
<li class="chapter" data-level="1.1.2" data-path=""><a href="#unnesting-data"><i class="fa fa-check"></i><b>1.1.2</b> Unnesting data</a></li>
<li class="chapter" data-level="1.1.3" data-path=""><a href="#working-with-list-columns"><i class="fa fa-check"></i><b>1.1.3</b> Working with list columns</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path=""><a href="#iteration-with-map"><i class="fa fa-check"></i><b>1.2</b> Iteration with <code>map</code></a><ul>
<li class="chapter" data-level="1.2.1" data-path=""><a href="#basic-use-of-map"><i class="fa fa-check"></i><b>1.2.1</b> Basic use of <code>map</code></a></li>
<li class="chapter" data-level="1.2.2" data-path=""><a href="#map-variants-returning-vectors"><i class="fa fa-check"></i><b>1.2.2</b> <code>map</code> variants returning vectors</a></li>
<li class="chapter" data-level="1.2.3" data-path=""><a href="#map-variants-returning-dataframes"><i class="fa fa-check"></i><b>1.2.3</b> <code>map</code> variants returning dataframes</a></li>
<li class="chapter" data-level="1.2.4" data-path=""><a href="#selective-mapping"><i class="fa fa-check"></i><b>1.2.4</b> Selective mapping</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path=""><a href="#more-map-variants"><i class="fa fa-check"></i><b>1.3</b> More <code>map</code> variants</a><ul>
<li class="chapter" data-level="1.3.1" data-path=""><a href="#mapping-over-two-inputs-with-map2"><i class="fa fa-check"></i><b>1.3.1</b> Mapping over two inputs with map2</a></li>
<li class="chapter" data-level="1.3.2" data-path=""><a href="#mapping-over-multiple-inputs-with-pmap"><i class="fa fa-check"></i><b>1.3.2</b> Mapping over multiple inputs with pmap</a></li>
<li class="chapter" data-level="1.3.3" data-path=""><a href="#mapping-at-depth"><i class="fa fa-check"></i><b>1.3.3</b> Mapping at depth</a></li>
<li class="chapter" data-level="1.3.4" data-path=""><a href="#iteration-without-a-return"><i class="fa fa-check"></i><b>1.3.4</b> Iteration without a return</a></li>
<li class="chapter" data-level="1.3.5" data-path=""><a href="#modify-rather-than-map"><i class="fa fa-check"></i><b>1.3.5</b> Modify rather than map</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path=""><a href="#working-with-lists"><i class="fa fa-check"></i><b>1.4</b> Working with lists</a><ul>
<li class="chapter" data-level="1.4.1" data-path=""><a href="#filtering-lists"><i class="fa fa-check"></i><b>1.4.1</b> Filtering lists</a></li>
<li class="chapter" data-level="1.4.2" data-path=""><a href="#summarising-lists"><i class="fa fa-check"></i><b>1.4.2</b> Summarising lists</a></li>
<li class="chapter" data-level="1.4.3" data-path=""><a href="#reduction-and-accumulation"><i class="fa fa-check"></i><b>1.4.3</b> Reduction and accumulation</a></li>
<li class="chapter" data-level="1.4.4" data-path=""><a href="#miscellaneous-operation"><i class="fa fa-check"></i><b>1.4.4</b> Miscellaneous operation</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:title:end-->
<!--bookdown:title:start-->
<div id="working-with-lists-and-iteration" class="section level1">
<h1><span class="header-section-number">Section 1</span> Working with lists and iteration</h1>
<p><img src="opening-image.png" /></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># load the tidyverse</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(tidyverse)</a></code></pre></div>
<pre><code>## ── Attaching packages ───────────────────────────────────────────── tidyverse 1.3.0 ──</code></pre>
<pre><code>## ✓ ggplot2 3.3.0     ✓ purrr   0.3.4
## ✓ tibble  3.0.1     ✓ dplyr   0.8.5
## ✓ tidyr   1.0.2     ✓ stringr 1.4.0
## ✓ readr   1.3.1     ✓ forcats 0.5.0</code></pre>
<pre><code>## ── Conflicts ──────────────────────────────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<div id="list-columns-with-tidyr" class="section level2">
<h2><span class="header-section-number">1.1</span> List columns with <code>tidyr</code></h2>
<div id="nesting-data" class="section level3">
<h3><span class="header-section-number">1.1.1</span> Nesting data</h3>
<p>It may become necessary to indicate the groups of a tibble in a somewhat more explicit way than simply using <code>dplyr::group_by</code>. <code>tidyr</code> offers the option to create nested tibbles, that is, to store complex objects in the columns of a tibble. This includes other tibbles, as well as model objects and plots.</p>
<p><em>NB:</em> Nesting data is done using <code>tidyr::nest</code>, which is different from the similarly named <code>tidyr::nesting</code>.</p>
<p>The example below shows how <code>mtcars</code> can be converted into a nested tibble.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># nest mtcars into a list of dataframes based on number of cylinders</span></a>
<a class="sourceLine" id="cb5-2" title="2">nested_cars =<span class="st"> </span><span class="kw">as_tibble</span>(mtcars, </a>
<a class="sourceLine" id="cb5-3" title="3">                        <span class="dt">rownames =</span> <span class="st">&quot;car_name&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="st">  </span><span class="kw">group_by</span>(cyl) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="st">  </span><span class="kw">nest</span>()</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7">nested_cars</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
## # Groups:   cyl [3]
##     cyl data              
##   &lt;dbl&gt; &lt;list&gt;            
## 1     6 &lt;tibble [7 × 11]&gt; 
## 2     4 &lt;tibble [11 × 11]&gt;
## 3     8 &lt;tibble [14 × 11]&gt;</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co"># get column class</span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">sapply</span>(nested_cars, class)</a></code></pre></div>
<pre><code>##       cyl      data 
## &quot;numeric&quot;    &quot;list&quot;</code></pre>
<p><code>mtcars</code> is now a nested data frame. The class of each of its columns is respectively, a numeric (number of cylinders) and a list (the data of all cars with as many cylinders as in the corresponding row).</p>
<p>While <code>nest</code> can be used without first grouping the tibble, it’s just much easier to group first.</p>
</div>
<div id="unnesting-data" class="section level3">
<h3><span class="header-section-number">1.1.2</span> Unnesting data</h3>
<p>A nested tibble can be converted back into the original, or into a processed form, using <code>tidyr::unnest</code>. The original groups are retained.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co"># use unnest to recover the original data frame</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">unnest</span>(nested_cars, <span class="dt">cols =</span> <span class="st">&quot;data&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 32 x 12
## # Groups:   cyl [3]
##      cyl car_name      mpg  disp    hp  drat    wt  qsec    vs    am  gear  carb
##    &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1     6 Mazda RX4    21    160    110  3.9   2.62  16.5     0     1     4     4
##  2     6 Mazda RX4 …  21    160    110  3.9   2.88  17.0     0     1     4     4
##  3     6 Hornet 4 D…  21.4  258    110  3.08  3.22  19.4     1     0     3     1
##  4     6 Valiant      18.1  225    105  2.76  3.46  20.2     1     0     3     1
##  5     6 Merc 280     19.2  168.   123  3.92  3.44  18.3     1     0     4     4
##  6     6 Merc 280C    17.8  168.   123  3.92  3.44  18.9     1     0     4     4
##  7     6 Ferrari Di…  19.7  145    175  3.62  2.77  15.5     0     1     5     6
##  8     4 Datsun 710   22.8  108     93  3.85  2.32  18.6     1     1     4     1
##  9     4 Merc 240D    24.4  147.    62  3.69  3.19  20       1     0     4     2
## 10     4 Merc 230     22.8  141.    95  3.92  3.15  22.9     1     0     4     2
## # … with 22 more rows</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co"># unnesting preserves groups</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="kw">groups</span>(<span class="kw">unnest</span>(nested_cars, <span class="dt">cols =</span> <span class="st">&quot;data&quot;</span>))</a></code></pre></div>
<pre><code>## [[1]]
## cyl</code></pre>
<p>The <code>unnest_longer</code> and <code>unnest_wider</code> variants of <code>unnest</code> are maturing functions, that is, not in their final form. They allow interesting variations on unnesting — these are shown here but advised against.</p>
<p>Unnest the data first, and then convert it to the form needed.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">unnest_longer</span>(nested_cars, <span class="dt">col =</span> <span class="st">&quot;data&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="st">  </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 x 2
## # Groups:   cyl [1]
##     cyl data$car_name  $mpg $disp   $hp $drat   $wt $qsec   $vs   $am $gear
##   &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     6 Mazda RX4      21    160    110  3.9   2.62  16.5     0     1     4
## 2     6 Mazda RX4 Wag  21    160    110  3.9   2.88  17.0     0     1     4
## 3     6 Hornet 4 Dri…  21.4  258    110  3.08  3.22  19.4     1     0     3
## 4     6 Valiant        18.1  225    105  2.76  3.46  20.2     1     0     3
## 5     6 Merc 280       19.2  168.   123  3.92  3.44  18.3     1     0     4
## 6     6 Merc 280C      17.8  168.   123  3.92  3.44  18.9     1     0     4
## # … with 1 more variable: $carb &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">unnest_wider</span>(nested_cars, <span class="dt">col =</span> <span class="st">&quot;data&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 12
## # Groups:   cyl [3]
##     cyl car_name  mpg    disp   hp     drat  wt    qsec  vs    am    gear  carb 
##   &lt;dbl&gt; &lt;list&gt;    &lt;list&gt; &lt;list&gt; &lt;list&gt; &lt;lis&gt; &lt;lis&gt; &lt;lis&gt; &lt;lis&gt; &lt;lis&gt; &lt;lis&gt; &lt;lis&gt;
## 1     6 &lt;chr [7]&gt; &lt;dbl … &lt;dbl … &lt;dbl … &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl…
## 2     4 &lt;chr [11… &lt;dbl … &lt;dbl … &lt;dbl … &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl…
## 3     8 &lt;chr [14… &lt;dbl … &lt;dbl … &lt;dbl … &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl… &lt;dbl…</code></pre>
</div>
<div id="working-with-list-columns" class="section level3">
<h3><span class="header-section-number">1.1.3</span> Working with list columns</h3>
<p>The class of a list column is <code>list</code>, and functions that deal with lists can be used on list columns too, within the bounds of what is allowed in a tibble.</p>
<p>That is, one cannot add more elements to a list column than there are rows in the tibble.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">tryCatch</span>(</a>
<a class="sourceLine" id="cb17-2" title="2">  <span class="dt">expr =</span> {</a>
<a class="sourceLine" id="cb17-3" title="3">    nested_cars<span class="op">$</span>data =<span class="st"> </span><span class="kw">append</span>(nested_cars<span class="op">$</span>data, <span class="st">&quot;a&quot;</span>)    </a>
<a class="sourceLine" id="cb17-4" title="4">  },</a>
<a class="sourceLine" id="cb17-5" title="5">  <span class="dt">error =</span> <span class="cf">function</span>(e){</a>
<a class="sourceLine" id="cb17-6" title="6">    <span class="kw">print</span>(<span class="kw">as.character</span>(e))</a>
<a class="sourceLine" id="cb17-7" title="7">  }</a>
<a class="sourceLine" id="cb17-8" title="8">)</a></code></pre></div>
<pre><code>## [1] &quot;Error: Assigned data `append(nested_cars$data, \&quot;a\&quot;)` must be compatible with existing data.\nx Existing data has 3 rows.\nx Assigned data has 4 rows.\nℹ Only vectors of size 1 are recycled.\n&quot;</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">lapply</span>(nested_cars<span class="op">$</span>data, class)</a></code></pre></div>
<pre><code>## [[1]]
## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;
## 
## [[2]]
## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;
## 
## [[3]]
## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="co"># get the number of rows per dataframe</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co"># the mean mileage</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="co"># and the first car</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="co"># some_data = some_data %&gt;% </span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co">#   mutate(n_rows = map_int(data, nrow),</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co">#          mean_mpg = map_dbl(data, ~mean(.$mpg)),</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">#          first_car = map_chr(data, ~first(.$car_name)))</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co"># </span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co"># some_data</span></a></code></pre></div>
</div>
</div>
<div id="iteration-with-map" class="section level2">
<h2><span class="header-section-number">1.2</span> Iteration with <code>map</code></h2>
<p>Iteration in base <code>R</code> is commonly done with <code>for</code> and <code>while</code> loops.
There is no readymade alternative to <code>while</code> loops in the tidyverse.
However, the functionality of <code>for</code> loops is spread over the <code>map</code> family of functions from <code>purrr</code>.</p>
<p><code>purrr</code> functions are <em>functionals</em>, i.e., functions that take another function as an argument.
The closest equivalent in <code>R</code> is the <code>*apply</code> family of functions: <code>apply</code>, <code>lapply</code>, <code>vapply</code> and so on.</p>
<p>A good reason to use <code>purrr</code> functions instead of base <code>R</code> functions is their consistent and clear naming, which always indicates how they should be used.
This is explained in the examples below.</p>
<p>These reasons, as well as how <code>map</code> is different from <code>for</code> and <code>lapply</code> are best explained in the <strong><a href="https://adv-r.hadley.nz/functionals.html">Advanced R Book</a></strong>.</p>
<div id="basic-use-of-map" class="section level3">
<h3><span class="header-section-number">1.2.1</span> Basic use of <code>map</code></h3>
<p><code>map</code> works on any list-like object, which includes vectors, and always returns a list. <code>map</code> takes two arguments, the object on which to operate, and the function to apply to each element.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="co"># get the square root of each integer 1 - 10</span></a>
<a class="sourceLine" id="cb22-2" title="2">some_numbers =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="kw">map</span>(some_numbers, sqrt)</a></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 1.414214
## 
## [[3]]
## [1] 1.732051
## 
## [[4]]
## [1] 2
## 
## [[5]]
## [1] 2.236068
## 
## [[6]]
## [1] 2.44949
## 
## [[7]]
## [1] 2.645751
## 
## [[8]]
## [1] 2.828427
## 
## [[9]]
## [1] 3
## 
## [[10]]
## [1] 3.162278</code></pre>
</div>
<div id="map-variants-returning-vectors" class="section level3">
<h3><span class="header-section-number">1.2.2</span> <code>map</code> variants returning vectors</h3>
<p>Though <code>map</code> always returns a list, it has variants named <code>map_*</code> where the suffix indicates the return type.
<code>map_chr</code>, <code>map_dbl</code>, <code>map_int</code>, and <code>map_lgl</code> return character, double (numeric), integer, and logical vectors.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="co"># use map_dbl to get a vector of square roots</span></a>
<a class="sourceLine" id="cb24-2" title="2">some_numbers =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">10</span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="kw">map_dbl</span>(some_numbers, sqrt)</a></code></pre></div>
<pre><code>##  [1] 1.000000 1.414214 1.732051 2.000000 2.236068 2.449490 2.645751 2.828427
##  [9] 3.000000 3.162278</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="co"># map_chr will convert the output to a character</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="kw">map_chr</span>(some_numbers, sqrt)</a></code></pre></div>
<pre><code>##  [1] &quot;1.000000&quot; &quot;1.414214&quot; &quot;1.732051&quot; &quot;2.000000&quot; &quot;2.236068&quot; &quot;2.449490&quot;
##  [7] &quot;2.645751&quot; &quot;2.828427&quot; &quot;3.000000&quot; &quot;3.162278&quot;</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="co"># map_int will NOT round the output to an integer</span></a>
<a class="sourceLine" id="cb28-2" title="2"></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="co"># map_lgl returns TRUE/FALSE values</span></a>
<a class="sourceLine" id="cb28-4" title="4">some_numbers =<span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="ot">NA</span>, <span class="ot">NaN</span>, <span class="ot">Inf</span>, <span class="op">-</span><span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb28-5" title="5"><span class="kw">map_lgl</span>(some_numbers, is.na)</a></code></pre></div>
<pre><code>## [1]  TRUE FALSE FALSE FALSE  TRUE  TRUE FALSE FALSE</code></pre>
<p><code>map</code> accepts multiple functions that are applied in sequence to the input list-like object, but this is confusing to the reader and ill advised.</p>
</div>
<div id="map-variants-returning-dataframes" class="section level3">
<h3><span class="header-section-number">1.2.3</span> <code>map</code> variants returning dataframes</h3>
<p><code>map_df</code> returns data frames, and by default binds dataframes by rows, while <code>map_dfr</code> does this explicitly, and <code>map_dfc</code> does returns a dataframe bound by column.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1"><span class="co"># split mtcars into 3 dataframes, one per cylinder number</span></a>
<a class="sourceLine" id="cb30-2" title="2">some_list =<span class="st"> </span><span class="kw">split</span>(mtcars, mtcars<span class="op">$</span>cyl)</a>
<a class="sourceLine" id="cb30-3" title="3"></a>
<a class="sourceLine" id="cb30-4" title="4"><span class="co"># get the first two rows of each dataframe</span></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="kw">map_df</span>(some_list, head, <span class="dt">n =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 2 24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## 3 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 4 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 5 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 6 14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4</code></pre>
<p><code>map</code> accepts arguments to the function being mapped, such as in the example above, where <code>head()</code> accepts the argument <code>n = 2</code>.</p>
<p><code>map_dfr</code> behaves the same as <code>map_df</code>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1"><span class="co"># the same as above but with a pipe</span></a>
<a class="sourceLine" id="cb32-2" title="2">some_list <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-3" title="3"><span class="st">  </span><span class="kw">map_dfr</span>(head, <span class="dt">n =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##    mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## 1 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## 2 24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## 3 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 4 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 5 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 6 14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4</code></pre>
<p><code>map_dfc</code> binds the resulting 3 data frames of two rows each by column, and automatically repairs the column names, adding a suffix to each duplicate.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">some_list <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="st">  </span><span class="kw">map_dfc</span>(head, <span class="dt">n =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##    mpg cyl  disp hp drat   wt  qsec vs am gear carb mpg1 cyl1 disp1 hp1 drat1
## 1 22.8   4 108.0 93 3.85 2.32 18.61  1  1    4    1   21    6   160 110   3.9
## 2 24.4   4 146.7 62 3.69 3.19 20.00  1  0    4    2   21    6   160 110   3.9
##     wt1 qsec1 vs1 am1 gear1 carb1 mpg2 cyl2 disp2 hp2 drat2  wt2 qsec2 vs2 am2
## 1 2.620 16.46   0   1     4     4 18.7    8   360 175  3.15 3.44 17.02   0   0
## 2 2.875 17.02   0   1     4     4 14.3    8   360 245  3.21 3.57 15.84   0   0
##   gear2 carb2
## 1     3     2
## 2     3     4</code></pre>
</div>
<div id="selective-mapping" class="section level3">
<h3><span class="header-section-number">1.2.4</span> Selective mapping</h3>
<p><code>map_at</code> and <code>map_if</code> work like other <code>*_at</code> and <code>*_if</code> functions.</p>
<p>Here, <code>map_if</code> is used to run a linear model only on those dataframes which have sufficient data. The predicate is specified by <code>.p</code>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1"><span class="co"># split mtcars by cylinder number and run an lm only if there are more than 10 rows</span></a>
<a class="sourceLine" id="cb36-2" title="2">data &lt;-<span class="st"> </span><span class="kw">nest</span>(mtcars, <span class="dt">data =</span> <span class="op">-</span>cyl)</a>
<a class="sourceLine" id="cb36-3" title="3"></a>
<a class="sourceLine" id="cb36-4" title="4">data &lt;-<span class="st"> </span><span class="kw">mutate</span>(data,</a>
<a class="sourceLine" id="cb36-5" title="5">               <span class="dt">model =</span> <span class="kw">map_if</span>(<span class="dt">.x =</span> data,</a>
<a class="sourceLine" id="cb36-6" title="6">                              <span class="dt">.p =</span> <span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb36-7" title="7">                                <span class="kw">nrow</span>(x) <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb36-8" title="8">                              },</a>
<a class="sourceLine" id="cb36-9" title="9">                              <span class="dt">.f =</span> <span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb36-10" title="10">                                <span class="kw">lm</span>(mpg <span class="op">~</span><span class="st"> </span>wt, <span class="dt">data =</span> x)</a>
<a class="sourceLine" id="cb36-11" title="11">                              }))</a>
<a class="sourceLine" id="cb36-12" title="12"><span class="co"># check the data structure</span></a>
<a class="sourceLine" id="cb36-13" title="13">data</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##     cyl data               model            
##   &lt;dbl&gt; &lt;list&gt;             &lt;list&gt;           
## 1     6 &lt;tibble [7 × 10]&gt;  &lt;tibble [7 × 10]&gt;
## 2     4 &lt;tibble [11 × 10]&gt; &lt;lm&gt;             
## 3     8 &lt;tibble [14 × 10]&gt; &lt;lm&gt;</code></pre>
<p><code>map_at</code> works on specific elements of a list or vector. Come back to this, it’s not particularly useful.</p>
</div>
</div>
<div id="more-map-variants" class="section level2">
<h2><span class="header-section-number">1.3</span> More <code>map</code> variants</h2>
<p><code>map</code> also has variants along the axis of how many elements are operated upon. <code>map2</code> operates on two vectors or list-like elements, and returns a single list as output.
The output has as many elements as the input lists, which must be of the same length.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1"><span class="co"># consider 2 vectors and replicate the simple vector addition using map2</span></a>
<a class="sourceLine" id="cb38-2" title="2"><span class="kw">map2</span>(<span class="dt">.x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, </a>
<a class="sourceLine" id="cb38-3" title="3">     <span class="dt">.y =</span> <span class="dv">6</span><span class="op">:</span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb38-4" title="4">     <span class="dt">.f =</span> sum)</a></code></pre></div>
<pre><code>## [[1]]
## [1] 7
## 
## [[2]]
## [1] 9
## 
## [[3]]
## [1] 11
## 
## [[4]]
## [1] 13
## 
## [[5]]
## [1] 15</code></pre>
<div id="mapping-over-two-inputs-with-map2" class="section level3">
<h3><span class="header-section-number">1.3.1</span> Mapping over two inputs with map2</h3>
<p><code>map2</code> has the same variants as <code>map</code>, allowing for different return types.
Here <code>map2_int</code> returns an integer vector.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1"><span class="co"># consider 2 vectors and replicate the simple vector addition using map2</span></a>
<a class="sourceLine" id="cb40-2" title="2"><span class="kw">map2_int</span>(<span class="dt">.x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, </a>
<a class="sourceLine" id="cb40-3" title="3">     <span class="dt">.y =</span> <span class="dv">6</span><span class="op">:</span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb40-4" title="4">     <span class="dt">.f =</span> sum)</a></code></pre></div>
<pre><code>## [1]  7  9 11 13 15</code></pre>
<p><code>map2</code> doesn’t have <code>_at</code> and <code>_if</code> variants.</p>
<p>One use case for <code>map2</code> is to deal with both a list element and its index, as shown in the example. This may be necessary when the list index is removed in a <code>split</code> or <code>nest</code>. This can also be done with <code>imap</code>, where the index is referred to as <code>.y</code>.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1"><span class="co"># make a named list for this example</span></a>
<a class="sourceLine" id="cb42-2" title="2">this_list =<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="st">&quot;first letter&quot;</span>,</a>
<a class="sourceLine" id="cb42-3" title="3">                 <span class="dt">b =</span> <span class="st">&quot;second letter&quot;</span>)</a>
<a class="sourceLine" id="cb42-4" title="4"></a>
<a class="sourceLine" id="cb42-5" title="5"><span class="co"># a not particularly useful example</span></a>
<a class="sourceLine" id="cb42-6" title="6"><span class="kw">map2</span>(this_list, <span class="kw">names</span>(this_list),</a>
<a class="sourceLine" id="cb42-7" title="7">     <span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb42-8" title="8">       glue<span class="op">::</span><span class="kw">glue</span>(<span class="st">&#39;{x} : {y}&#39;</span>)</a>
<a class="sourceLine" id="cb42-9" title="9">     })</a></code></pre></div>
<pre><code>## $a
## first letter : a
## 
## $b
## second letter : b</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1"><span class="co"># imap can also do this</span></a>
<a class="sourceLine" id="cb44-2" title="2"><span class="kw">imap</span>(this_list,</a>
<a class="sourceLine" id="cb44-3" title="3">     <span class="cf">function</span>(x, .y){</a>
<a class="sourceLine" id="cb44-4" title="4">       glue<span class="op">::</span><span class="kw">glue</span>(<span class="st">&#39;{x} : {.y}&#39;</span>)</a>
<a class="sourceLine" id="cb44-5" title="5">     })</a></code></pre></div>
<pre><code>## $a
## first letter : a
## 
## $b
## second letter : b</code></pre>
</div>
<div id="mapping-over-multiple-inputs-with-pmap" class="section level3">
<h3><span class="header-section-number">1.3.2</span> Mapping over multiple inputs with pmap</h3>
<p><code>pmap</code> instead operates on a list of multiple list-like objects, and also comes with the same return type variants as <code>map</code>. The example shows both aspects of <code>pmap</code> using <code>pmap_chr</code>.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1"><span class="co"># operate on three different lists</span></a>
<a class="sourceLine" id="cb46-2" title="2">list_<span class="dv">01</span> =<span class="st"> </span><span class="kw">as.list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb46-3" title="3">list_<span class="dv">02</span> =<span class="st"> </span><span class="kw">as.list</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb46-4" title="4">list_<span class="dv">03</span> =<span class="st"> </span><span class="kw">as.list</span>(<span class="kw">rainbow</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb46-5" title="5"></a>
<a class="sourceLine" id="cb46-6" title="6"><span class="co"># print a few statements</span></a>
<a class="sourceLine" id="cb46-7" title="7"><span class="kw">pmap_chr</span>(<span class="kw">list</span>(list_<span class="dv">01</span>, list_<span class="dv">02</span>, list_<span class="dv">03</span>),</a>
<a class="sourceLine" id="cb46-8" title="8">     <span class="cf">function</span>(l1, l2, l3){</a>
<a class="sourceLine" id="cb46-9" title="9">       glue<span class="op">::</span><span class="kw">glue</span>(<span class="st">&#39;number {l1}, letter {l2}, colour {l3}&#39;</span>)</a>
<a class="sourceLine" id="cb46-10" title="10">     })</a></code></pre></div>
<pre><code>## [1] &quot;number 1, letter a, colour #FF0000FF&quot;
## [2] &quot;number 2, letter b, colour #00FF00FF&quot;
## [3] &quot;number 3, letter c, colour #0000FFFF&quot;</code></pre>
</div>
<div id="mapping-at-depth" class="section level3">
<h3><span class="header-section-number">1.3.3</span> Mapping at depth</h3>
<p>Lists are often nested, that is, a list element may itself be a list. It is possible to map a function over elements as a specific depth.</p>
<p>In the example, <code>mtcars</code> is split by cylinders, and then by gears, creating a two-level list, with the second layer operated on.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1"><span class="co"># use map to make a 2 level list</span></a>
<a class="sourceLine" id="cb48-2" title="2">this_list =<span class="st"> </span><span class="kw">split</span>(mtcars, mtcars<span class="op">$</span>cyl) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb48-3" title="3"><span class="st">  </span><span class="kw">map</span>(<span class="cf">function</span>(df){ <span class="kw">split</span>(df, df<span class="op">$</span>gear) })</a>
<a class="sourceLine" id="cb48-4" title="4"></a>
<a class="sourceLine" id="cb48-5" title="5"><span class="co"># map over the second level to count the number of </span></a>
<a class="sourceLine" id="cb48-6" title="6"><span class="co"># cars with N gears in the set of cars with M cylinders</span></a>
<a class="sourceLine" id="cb48-7" title="7"><span class="co"># display only for cyl = 4</span></a>
<a class="sourceLine" id="cb48-8" title="8"><span class="kw">map_depth</span>(this_list[<span class="dv">1</span>], <span class="dv">2</span>, nrow)</a></code></pre></div>
<pre><code>## $`4`
## $`4`$`3`
## [1] 1
## 
## $`4`$`4`
## [1] 8
## 
## $`4`$`5`
## [1] 2</code></pre>
</div>
<div id="iteration-without-a-return" class="section level3">
<h3><span class="header-section-number">1.3.4</span> Iteration without a return</h3>
<p><code>map</code> and its variants have a return type, which is either a list or a vector.
However, it is often necessary to iterate a function over a list-like object for that function’s side effects, such as printing a message to screen, plotting a series of figures, or saving to file.</p>
<p><code>walk</code> is the function for this task. It has only the variants <code>walk2</code>, <code>iwalk</code>, and <code>pwalk</code>, whose logic is similar to <code>map2</code>, <code>imap</code>, and <code>pmap</code>. In the example, the function applied to each list element is intended to print a message.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1">this_list =<span class="st"> </span><span class="kw">split</span>(mtcars, mtcars<span class="op">$</span>cyl)</a>
<a class="sourceLine" id="cb50-2" title="2"></a>
<a class="sourceLine" id="cb50-3" title="3"><span class="kw">iwalk</span>(this_list,</a>
<a class="sourceLine" id="cb50-4" title="4">     <span class="cf">function</span>(df, .y){</a>
<a class="sourceLine" id="cb50-5" title="5">       <span class="kw">message</span>(glue<span class="op">::</span><span class="kw">glue</span>(<span class="st">&#39;{nrow(df)} cars with {.y} cylinders&#39;</span>))</a>
<a class="sourceLine" id="cb50-6" title="6">     })</a></code></pre></div>
<pre><code>## 11 cars with 4 cylinders</code></pre>
<pre><code>## 7 cars with 6 cylinders</code></pre>
<pre><code>## 14 cars with 8 cylinders</code></pre>
</div>
<div id="modify-rather-than-map" class="section level3">
<h3><span class="header-section-number">1.3.5</span> Modify rather than map</h3>
<p>When the return type is expected to be the same as the input type, that is, a list returning a list, or a character vector returning the same, <code>modify</code> can help with keeping strictly to those expectations.</p>
<p>In the example, simply adding 2 to each vector element produces an error, because the output is a <code>numeric</code>, or <code>double</code>. <code>modify</code> helps ensure some type safety in this way.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1">vec =<span class="st"> </span><span class="kw">as.integer</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb54-2" title="2"></a>
<a class="sourceLine" id="cb54-3" title="3"><span class="kw">tryCatch</span>(</a>
<a class="sourceLine" id="cb54-4" title="4">  <span class="dt">expr =</span> {</a>
<a class="sourceLine" id="cb54-5" title="5">    </a>
<a class="sourceLine" id="cb54-6" title="6">    <span class="co"># this is what we want you to look at</span></a>
<a class="sourceLine" id="cb54-7" title="7">    </a>
<a class="sourceLine" id="cb54-8" title="8">    <span class="kw">modify</span>(vec, <span class="cf">function</span>(x) { (x <span class="op">+</span><span class="st"> </span><span class="dv">2</span>) })</a>
<a class="sourceLine" id="cb54-9" title="9">    </a>
<a class="sourceLine" id="cb54-10" title="10">    },</a>
<a class="sourceLine" id="cb54-11" title="11">  </a>
<a class="sourceLine" id="cb54-12" title="12">  <span class="co"># do not pay attention to this</span></a>
<a class="sourceLine" id="cb54-13" title="13">  <span class="dt">error =</span> <span class="cf">function</span>(e){</a>
<a class="sourceLine" id="cb54-14" title="14">    <span class="kw">print</span>(<span class="kw">toString</span>(e))</a>
<a class="sourceLine" id="cb54-15" title="15">  }</a>
<a class="sourceLine" id="cb54-16" title="16">)</a></code></pre></div>
<pre><code>## [1] &quot;Error: Can&#39;t coerce element 1 from a double to a integer\n&quot;</code></pre>
<p>Converting the output to an integer, which was the original input type, serves as a solution.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" title="1"><span class="kw">modify</span>(vec, <span class="cf">function</span>(x) { <span class="kw">as.integer</span>(x <span class="op">+</span><span class="st"> </span><span class="dv">2</span>) })</a></code></pre></div>
<pre><code>##  [1]  3  4  5  6  7  8  9 10 11 12</code></pre>
<div id="a-note-on-invoke" class="section level4 unnumbered">
<h4>A note on <code>invoke</code></h4>
<p><code>invoke</code> used to be a wrapper around <code>do.call</code>, and can still be found with its family of functions in <code>purrr</code>. It is however retired in favour of functionality already present in <code>map</code> and <code>rlang::exec</code>, the latter of which will be covered in another session.</p>
</div>
</div>
</div>
<div id="working-with-lists" class="section level2">
<h2><span class="header-section-number">1.4</span> Working with lists</h2>
<p><code>purrr</code> has a number of functions to work with lists, especially lists that are not nested list-columns in a tibble.</p>
<div id="filtering-lists" class="section level3">
<h3><span class="header-section-number">1.4.1</span> Filtering lists</h3>
<p>Lists can be filtered on any predicate using <code>keep</code>, while the special case <code>compact</code> is applied when the empty elements of a list are to be filtered out. <code>discard</code> is the opposite of <code>keep</code>, and keeps only elements not satisfying a condition. Again, the predicate is specified by <code>.p</code>.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1"><span class="co"># a list containing numbers</span></a>
<a class="sourceLine" id="cb58-2" title="2">this_list =<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="dv">1</span>, <span class="dt">b =</span> <span class="dv">-1</span>, <span class="dt">c =</span> <span class="dv">2</span>, <span class="dt">d =</span> <span class="ot">NULL</span>, <span class="dt">e =</span> <span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb58-3" title="3"></a>
<a class="sourceLine" id="cb58-4" title="4"><span class="co"># remove the empty element</span></a>
<a class="sourceLine" id="cb58-5" title="5"><span class="co"># this must be done before using keep on the list</span></a>
<a class="sourceLine" id="cb58-6" title="6">this_list =<span class="st"> </span><span class="kw">compact</span>(this_list)</a></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1"><span class="co"># use discard to remove the NA</span></a>
<a class="sourceLine" id="cb59-2" title="2">this_list =<span class="st"> </span><span class="kw">discard</span>(this_list, <span class="dt">.p =</span>is.na)</a>
<a class="sourceLine" id="cb59-3" title="3"></a>
<a class="sourceLine" id="cb59-4" title="4"><span class="co"># keep list elements which are positive</span></a>
<a class="sourceLine" id="cb59-5" title="5"><span class="kw">keep</span>(this_list, <span class="dt">.p =</span> <span class="cf">function</span>(x){ x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> })</a></code></pre></div>
<pre><code>## $a
## [1] 1
## 
## $c
## [1] 2</code></pre>
<p><code>head_while</code> is bit of an odd case, which returns all elements of a list-like object in sequence until the first one fails to satisfy a predicate, specified by <code>.p</code>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" title="1"><span class="dv">1</span><span class="op">:</span><span class="dv">10</span> <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-2" title="2"><span class="st">  </span><span class="kw">head_while</span>(<span class="dt">.p =</span> <span class="cf">function</span>(x) x <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>)</a></code></pre></div>
<pre><code>## [1] 1 2 3 4</code></pre>
</div>
<div id="summarising-lists" class="section level3">
<h3><span class="header-section-number">1.4.2</span> Summarising lists</h3>
<p>The <code>purrr</code> functions <code>every</code>, <code>some</code>, <code>has_element</code>, <code>detect</code>, <code>detect_index</code>, and <code>vec_depth</code> help determine whether a list passes a certain logical test or not. These are seldom used and are not discussed here.</p>
</div>
<div id="reduction-and-accumulation" class="section level3">
<h3><span class="header-section-number">1.4.3</span> Reduction and accumulation</h3>
<p><code>reduce</code> helps combine elements along a list using a specific function. Consider the example below where list elements are concatenated into a single vector.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" title="1">this_list =<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">b =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">c =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb63-2" title="2"></a>
<a class="sourceLine" id="cb63-3" title="3"><span class="kw">reduce</span>(this_list, c)</a></code></pre></div>
<pre><code>##  [1]  1  2  3  3  4  5  6  7  8  9 10</code></pre>
<p>The way <code>reduce</code> works is to take the first element, <code>a</code> in the example, and find its intersection with <code>b</code>, and to take the result and find its intersection with <code>c</code>.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" title="1">this_list =<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">b =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">c =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb65-2" title="2"></a>
<a class="sourceLine" id="cb65-3" title="3"><span class="kw">reduce</span>(this_list, intersect)</a></code></pre></div>
<pre><code>## [1] 3</code></pre>
<p><code>accumulate</code> works very similarly, except it retains the intermediate products. The first element is retained as is. <code>accumulate2</code> and <code>reduce2</code> work on two lists, following the same logic as <code>map2</code> etc.
Both functions can be used in much more complex ways than demonstrated here.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" title="1"><span class="co"># make a list</span></a>
<a class="sourceLine" id="cb67-2" title="2">this_list =<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">b =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">c =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">d =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">12</span>))</a>
<a class="sourceLine" id="cb67-3" title="3"></a>
<a class="sourceLine" id="cb67-4" title="4"><span class="co"># a multiple accumulate can help</span></a>
<a class="sourceLine" id="cb67-5" title="5"><span class="kw">accumulate</span>(this_list, union, <span class="dt">.dir =</span> <span class="st">&quot;forward&quot;</span>)</a></code></pre></div>
<pre><code>## $a
## [1] 1 2 3
## 
## $b
## [1] 1 2 3 4 5 6
## 
## $c
##  [1]  1  2  3  4  5  6  7  8  9 10
## 
## $d
##  [1]  1  2  3  4  5  6  7  8  9 10 12</code></pre>
</div>
<div id="miscellaneous-operation" class="section level3">
<h3><span class="header-section-number">1.4.4</span> Miscellaneous operation</h3>
<p><code>purrr</code> offers a few more functions to work with lists (or list like objects). <code>prepend</code> works very similarly to <code>append</code>, except it adds to the head of a list. <code>splice</code> adds multiple objects together in a list. <code>splice</code> will break the existing list structure of input lists.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" title="1"><span class="co"># use prepend to add values to the head of a list</span></a>
<a class="sourceLine" id="cb69-2" title="2"><span class="kw">prepend</span>(<span class="dt">x =</span> <span class="kw">list</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>), <span class="dt">values =</span> <span class="kw">list</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>))</a></code></pre></div>
<pre><code>## [[1]]
## [1] &quot;1&quot;
## 
## [[2]]
## [1] &quot;2&quot;
## 
## [[3]]
## [1] &quot;a&quot;
## 
## [[4]]
## [1] &quot;b&quot;</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" title="1"><span class="co"># use splice to add multiple elements together</span></a>
<a class="sourceLine" id="cb71-2" title="2"><span class="kw">splice</span>(<span class="kw">list</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>), <span class="kw">list</span>(<span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>), <span class="st">&quot;something else&quot;</span>)</a></code></pre></div>
<pre><code>## [[1]]
## [1] &quot;a&quot;
## 
## [[2]]
## [1] &quot;b&quot;
## 
## [[3]]
## [1] &quot;1&quot;
## 
## [[4]]
## [1] &quot;2&quot;
## 
## [[5]]
## [1] &quot;something else&quot;</code></pre>
<p><code>flatten</code> has a similar behaviour, and converts a list of vectors or list of lists to a single list-like object. <code>flatten_*</code> options allow the output type to be specified.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" title="1">this_list =<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="kw">rep</span>(<span class="st">&quot;a&quot;</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb73-2" title="2">                 <span class="dt">b =</span> <span class="kw">rep</span>(<span class="st">&quot;b&quot;</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb73-3" title="3"></a>
<a class="sourceLine" id="cb73-4" title="4">this_list</a></code></pre></div>
<pre><code>## $a
## [1] &quot;a&quot; &quot;a&quot; &quot;a&quot;
## 
## $b
## [1] &quot;b&quot; &quot;b&quot; &quot;b&quot; &quot;b&quot;</code></pre>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" title="1"><span class="co"># use flatten chr to get a character vector</span></a>
<a class="sourceLine" id="cb75-2" title="2"><span class="kw">flatten_chr</span>(this_list)</a></code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;a&quot; &quot;a&quot; &quot;b&quot; &quot;b&quot; &quot;b&quot; &quot;b&quot;</code></pre>
<p><code>transpose</code> shifts the index order in multi-level lists. This is seen in the example, where the <code>gear</code> goes from being the index of the second level to the index of the first.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" title="1">this_list =<span class="st"> </span><span class="kw">split</span>(mtcars, mtcars<span class="op">$</span>cyl) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-2" title="2"><span class="st">  </span><span class="kw">map</span>(<span class="cf">function</span>(df) <span class="kw">split</span>(df, df<span class="op">$</span>gear))</a>
<a class="sourceLine" id="cb77-3" title="3"></a>
<a class="sourceLine" id="cb77-4" title="4"><span class="co"># from a list of lists where cars are divided by cylinders and then</span></a>
<a class="sourceLine" id="cb77-5" title="5"><span class="co"># gears, this is now a list of lists where cars are divided by</span></a>
<a class="sourceLine" id="cb77-6" title="6"><span class="co"># gears and then cylinders</span></a>
<a class="sourceLine" id="cb77-7" title="7"><span class="kw">transpose</span>(this_list[<span class="dv">1</span>])</a></code></pre></div>
<pre><code>## $`3`
## $`3`$`4`
##                mpg cyl  disp hp drat    wt  qsec vs am gear carb
## Toyota Corona 21.5   4 120.1 97  3.7 2.465 20.01  1  0    3    1
## 
## 
## $`4`
## $`4`$`4`
##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
## Datsun 710     22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
## Merc 240D      24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
## Merc 230       22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## Fiat 128       32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## Honda Civic    30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## Fiat X1-9      27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## Volvo 142E     21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## 
## 
## $`5`
## $`5`$`4`
##                mpg cyl  disp  hp drat    wt qsec vs am gear carb
## Porsche 914-2 26.0   4 120.3  91 4.43 2.140 16.7  0  1    5    2
## Lotus Europa  30.4   4  95.1 113 3.77 1.513 16.9  1  1    5    2</code></pre>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/pratikunterwegs/tres-tidy-tutorial/edit/master/%s",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
},
"search": false
});
});
</script>

</body>

</html>
